<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>

    <link rel="icon" href="tripode.ico">
    <link rel="stylesheet" href="glitchBG.css">
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <div class="glitch">
        <div class="glitch__item"></div>
        <div class="glitch__item"></div>
        <div class="glitch__item"></div>
        <div class="glitch__item"></div>
        <div class="glitch__item"></div>
        
    </div>
    
    <h1 class="glitch__title">AZIMUT</h1>
    <div class="forms-container">



        <div class="classic-inputs">







            <!-- <h1>Tripodes settings</h1> -->

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="upd_target_ip">UDP Target IP</label>
                    <input type="text" name="upd_target_ip" id="upd_target_ip" placeholder="Ip Addr"
                        value="%upd_target_ip%" required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
                <!-- <input class="cybr-btn" type="submit" value="Update">
        </input> -->
            </form>

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="upd_target_port">upd_target_port :</label>
                    <input type="text" name="upd_target_port" id="upd_target_port" placeholder="Ip Addr"
                        value="%upd_target_port%" required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
            </form>

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="upd_input_port">upd_input_port :</label>
                    <input type="text" name="upd_input_port" id="upd_input_port" placeholder="Ip Addr"
                        value="%upd_input_port%" required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
            </form>

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="osc_target_ip">osc_target_ip :</label>
                    <input type="text" name="osc_target_ip" id="osc_target_ip" placeholder="Ip Addr"
                        value="%osc_target_ip%" required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
            </form>

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="osc_target_port">osc_target_port :</label>
                    <input type="text" name="osc_target_port" id="osc_target_port" placeholder="Ip Addr"
                        value="%osc_target_port%" required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
            </form>

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="sta_ssid">sta_ssid :</label>
                    <input type="text" name="sta_ssid" id="sta_ssid" placeholder="Ip Addr" value="%sta_ssid%" required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
            </form>

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="sta_pswd">sta_pswd :</label>
                    <input type="text" name="sta_pswd" id="sta_pswd" placeholder="Ip Addr" value="%sta_pswd%" required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
            </form>

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="ap_ssid">ap_ssid :</label>
                    <input type="text" name="ap_ssid" id="ap_ssid" placeholder="Ip Addr" value="%ap_ssid%" required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
            </form>

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="ap_pswd">ap_pswd :</label>
                    <input type="text" name="ap_pswd" id="ap_pswd" placeholder="Ip Addr" value="%ap_pswd%" required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
            </form>

            <form onsubmit="showEvent(event)" class="cybr-form">
                <div class="cybr-input-container">
                    <label for="tripode_id">tripode_id :</label>
                    <input type="text" name="tripode_id" id="tripode_id" placeholder="Ip Addr" value="%tripode_id%"
                        required>
                </div>
                <button type='submit' class="cybr-btn">
                    Update
                    <span aria-hidden class="cybr-btn__glitch">Update</span>
                </button>
            </form>

        </div>
        <div class="commands-inputs">

            <form onsubmit="sendCommands(event)" class="commands-form">

                <div class="commands" id="commands">
                </div>
                <!-- <input type="submit" value="Update"> -->

                <div class="commands-buttons">

                    <button type='submit' class="cybr-btn">
                        Update
                        <span aria-hidden class="cybr-btn__glitch">Update</span>
                    </button>

                    <button style="font-size: 26px;" onclick="removeProtocolButton(event)" id="removeProtocol"
                        class="cybr-btn">
                        -
                        <span aria-hidden class="cybr-btn__glitch">-</span>
                    </button>
                    <button style="font-size: 20px;" onclick="addProtocolButton(event)" id="addProtocol" class="cybr-btn">
                        +
                        <span aria-hidden class="cybr-btn__glitch">+</span>
                    </button>
                </div>

                <!-- <button onclick="removeProtocolButton(event)" id="removeProtocol">Supprimer</button>
                <button onclick="addProtocolButton(event)" id="addProtocol">Ajouter</button> -->
            </form>

            <template id="commands-template">
                <div class="command ">
                    <div class="cybr-input-container">

                        <label for="command-nu">command :</label>
                        <input type="text" name="command-nu" id="command-nu" placeholder="command-nu"
                            value="%command-nu%" required>
                    </div>
                    <div class="protocols">
                        <div class="protocol">
                            <input type="radio" id="protocol-osc-nu" name="protocol-nu" value="osc">
                            <label for="protocol-osc-nu">OSC</label>
                        </div>
                        <div class="protocol">
                            <input type="radio" id="protocol-udp-nu" name="protocol-nu" value="udp">
                            <label for="protocol-udp-nu">UDP</label>
                        </div>
                    </div>
                </div>
            </template>
        </div>

    </div>


</body>
<script>

    var Socket = null;
    var values = new Object();

    let numberOfProtocols = 0;

    function showEvent(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const formProps = Object.fromEntries(formData);
        console.log("Event :", formProps);

        Socket.send(JSON.stringify(formProps));


    }

    function sendCommands(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const formProps = Object.fromEntries(formData);
        console.log("Event 42:", formProps);

        let responseObject = [];

        for (let index = 0; index < numberOfProtocols; index++) {
            responseObject.push({ type: formProps[`protocol-${index}`], value: formProps[`command-${index}`] });
        }
        console.log("Event 42 packet:", { signals: responseObject });
        Socket.send(JSON.stringify({ signals: responseObject }));
    }

    values["upd_target_ip"] = document.getElementById("upd_target_ip");
    values["upd_target_port"] = document.getElementById("upd_target_port");
    values["upd_input_port"] = document.getElementById("upd_input_port");
    values["osc_target_ip"] = document.getElementById("osc_target_ip");
    values["osc_target_port"] = document.getElementById("osc_target_port");
    values["sta_ssid"] = document.getElementById("sta_ssid");
    values["sta_pswd"] = document.getElementById("sta_pswd");
    values["ap_ssid"] = document.getElementById("ap_ssid");
    values["ap_pswd"] = document.getElementById("ap_pswd");
    values["tripode_id"] = document.getElementById("tripode_id");


    window.addEventListener("beforeunload", function (event) {
        if (Socket != null) {

            Socket.close();
        }

    })

    function addCommandToHtml({ value, type }, index) {
        const rowClone = document.getElementById("commands-template").content.cloneNode(true);
        rowClone.querySelector('.command').setAttribute('key', index);
        rowClone.querySelector('.command').setAttribute('id', `command-${index}-parent`);
        rowClone.getElementById("command-nu").value = value;
        rowClone.getElementById("command-nu").closest('div').querySelector('label').setAttribute("for", `command-${index}`);
        rowClone.getElementById("command-nu").name = `command-${index}`;
        rowClone.getElementById("command-nu").id = `command-${index}`;

        rowClone.getElementById("protocol-osc-nu").closest('div').querySelector('label').setAttribute("for", `protocol-osc-${index}`);
        rowClone.getElementById("protocol-osc-nu").name = `protocol-${index}`;
        if (type === 'osc') {
            rowClone.getElementById("protocol-osc-nu").setAttribute("checked", ``);
        }
        rowClone.getElementById("protocol-osc-nu").id = `protocol-osc-${index}`;

        rowClone.getElementById("protocol-udp-nu").closest('div').querySelector('label').setAttribute("for", `protocol-udp-${index}`);
        rowClone.getElementById("protocol-udp-nu").name = `protocol-${index}`;
        if (type === 'udp') {
            rowClone.getElementById("protocol-udp-nu").setAttribute("checked", ``);
        }
        rowClone.getElementById("protocol-udp-nu").id = `protocol-udp-${index}`;

        document.getElementById("commands").appendChild(rowClone);
    }

    function addProtocolButton(e) {
        e.preventDefault();
        addCommandToHtml({ value: '', type: 'udp' }, numberOfProtocols);
        numberOfProtocols++;
    }

    function removeProtocolButton(e) {
        e.preventDefault();
        if (numberOfProtocols > 1) {

            console.log("remove clic");
            const selectedElem = document.getElementById(`commands`);

            const element = document.getElementById(`command-${numberOfProtocols - 1}-parent`);
            console.log("OMG WTF", selectedElem, element, numberOfProtocols);
            selectedElem.removeChild(element);


            numberOfProtocols--;
        }
    }



    addEventListener('load', (event) => {




        // setTimeout(() => {

        //     const dataArray = [{ value: "write:;#0D300I255P1;12;12", type: 'udp' },
        //     { value: "write:;#0D300I255P1;12;13", type: 'osc' },
        //     { value: "write:;#0D300I255P1;12;14", type: 'udp' }];
        //             let child2 = document.getElementById(`commands`).lastElementChild; 
        //     while (child2) {
        //         console.log("child :", child2);
        //         document.getElementById(`commands`).removeChild(child2);
        //         child2 = document.getElementById(`commands`).lastElementChild;
        //     }
        //     numberOfProtocols = 0;
        //     dataArray.forEach((elem, index) => {
        //         addCommandToHtml(elem, index);

        //         numberOfProtocols++;
        //     })

        // }, 500);
        // let firstBtn = document.getElementById("firstBtn");
        // firstBtn.addEventListener('click', () => {
        //     Socket.send(JSON.stringify({
        //         signals: [{
        //             "value": "write:;#0D300I255P1;12;12",
        //             "type": "udp"
        //         },
        //         {
        //             "value": "write:;#0D300I255P1;12;13",
        //             "type": "osc"
        //         }
        //         ]
        //     }));
        // })

        if (window.location.hostname != "")
            Socket = new WebSocket('ws://' + window.location.hostname + '/ws');
        if (Socket) {
            Socket.addEventListener('message', function (event) {
                console.log('Message from server ', event.data);
                var arr_from_json = JSON.parse(event.data);
                console.log('Parsed json ', arr_from_json);

                for (const [key, value] of Object.entries(arr_from_json["settings"])) {
                    console.log(`kk ${key}: ${value}`);

                    values[key].value = value;

                }

                numberOfProtocols = 0;

                var child = document.getElementById(`commands`).lastElementChild;
                while (child) {
                    document.getElementById(`commands`).removeChild(child);
                    child = document.getElementById(`commands`).lastElementChild;
                }


                arr_from_json["signals"].forEach((elem, index) => {
                    addCommandToHtml(elem, index);

                    numberOfProtocols++;
                })




            })
            Socket.addEventListener('error', (event) => {
                console.log("Error WTF : ", event);
                window.location.reload();
            })
        }
    })
</script>

</html>